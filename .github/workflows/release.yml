name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-jar:
    name: Build JAR
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build with Gradle
      run: ./gradlew clean build -x test

    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: jar-file
        path: build/libs/*.jar
        retention-days: 1

  build-windows-exe:
    name: Build Windows EXE
    needs: build-jar
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: jar-file
        path: deploy/

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install Launch4j
      run: |
        choco install launch4j -y
      shell: pwsh

    - name: Install Inno Setup
      run: |
        choco install innosetup -y
      shell: pwsh

    - name: Create JRE bundle
      run: |
        cd deploy
        .\create-jre.bat
      shell: cmd

    - name: Build Windows installer
      run: |
        cd deploy
        .\build-m-inbody-simple.bat
      shell: cmd

    - name: Upload EXE installer
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: deploy/output/M-INBODY-Setup.exe

  create-release:
    name: Create Release
    needs: [build-jar, build-windows-exe]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - uses: actions/checkout@v3

    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: jar-file
        path: artifacts/

    - name: Download Windows installer
      uses: actions/download-artifact@v4
      with:
        name: windows-installer
        path: artifacts/

    - name: Get version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.version.outputs.VERSION }}
        body: |
          ## M-Inbody ${{ steps.version.outputs.VERSION }}

          ### ìƒˆë¡œìš´ ê¸°ëŠ¥
          - ğŸ“Š **íŒ¨í‚· í†µê³„ ìˆ˜ì§‘ ê¸°ëŠ¥ ì¶”ê°€**
            - ê²Œì„ìœ¼ë¡œë¶€í„° ìˆ˜ì‹ í•˜ëŠ” ëª¨ë“  íŒ¨í‚· íƒ€ì…ì„ ìë™ìœ¼ë¡œ ì¶”ì 
            - ìƒˆë¡œìš´ íŒ¨í‚· ë°œê²¬ ì‹œ ì½˜ì†”ì— ì‹¤ì‹œê°„ ì¶œë ¥
            - 30ì´ˆë§ˆë‹¤ ìë™ìœ¼ë¡œ JSON/CSV/Raw ë°ì´í„° íŒŒì¼ ì €ì¥

          - ğŸ” **ë¯¸ì§€ì˜ íŒ¨í‚· ë¶„ì„ ë„êµ¬**
            - íŒŒì‹±ë˜ì§€ ì•Šì€ íŒ¨í‚·ì˜ 16ì§„ìˆ˜ ë¤í”„
            - íŒ¨í‚· íƒ€ì…ë³„ ë¹ˆë„ í†µê³„
            - REST APIë¡œ ì‹¤ì‹œê°„ í†µê³„ ì¡°íšŒ ê°€ëŠ¥

          - ğŸ“ **ìë™ íŒŒì¼ ì €ì¥**
            - ì €ì¥ ìœ„ì¹˜: `~/m-inbody-packets/`
            - `packet-stats-latest.json` - ì „ì²´ í†µê³„
            - `packet-stats-latest.csv` - Excel í˜¸í™˜ CSV
            - `raw-dump-latest.txt` - Raw ë°ì´í„° ë¤í”„

          ### ì„¤ì¹˜ ë°©ë²•

          **Windows:**
          1. `M-INBODY-Setup.exe` ë‹¤ìš´ë¡œë“œ
          2. ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰
          3. Npcap ì„¤ì¹˜ (ìë™ ì•ˆë‚´)
          4. ë°”íƒ•í™”ë©´ ì•„ì´ì½˜ìœ¼ë¡œ ì‹¤í–‰

          **ê¸°íƒ€ í”Œë«í¼ (Java í•„ìš”):**
          1. `m-inbody-*.jar` ë‹¤ìš´ë¡œë“œ
          2. `java -jar m-inbody-*.jar` ì‹¤í–‰

          ### ì‚¬ìš© ë°©ë²•

          ìì„¸í•œ ë‚´ìš©ì€ [PACKET_ANALYSIS.md](https://github.com/doorBW/m-inbody/blob/main/PACKET_ANALYSIS.md) ì°¸ê³ 

          ### REST API
          ```bash
          # í†µê³„ ì¡°íšŒ
          curl http://localhost:5000/api/v1/packet-stats/summary

          # ìˆ˜ë™ ì €ì¥
          curl -X POST http://localhost:5000/api/v1/packet-stats/save

          # í†µê³„ ì´ˆê¸°í™”
          curl -X DELETE http://localhost:5000/api/v1/packet-stats/clear
          ```
        files: |
          artifacts/*.jar
          artifacts/*.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}