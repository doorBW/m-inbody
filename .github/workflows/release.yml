name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-jar:
    name: Build JAR
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build with Gradle
      run: ./gradlew clean build -x test

    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: jar-file
        path: build/libs/*.jar
        retention-days: 1

  build-windows-exe:
    name: Build Windows EXE
    needs: build-jar
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: jar-file
        path: deploy/

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install WiX Toolset
      run: choco install wixtoolset -y
      shell: pwsh

    - name: List downloaded JAR files
      run: |
        Write-Host "Contents of deploy folder:"
        Get-ChildItem -Path deploy -Recurse
      shell: pwsh

    - name: Prepare application files
      run: |
        Write-Host "Preparing application files..."

        # Find JAR file
        $jarFile = Get-ChildItem -Path deploy -Filter *.jar | Select-Object -First 1
        Write-Host "Found JAR: $($jarFile.Name)"

        # Create app directory
        New-Item -ItemType Directory -Force -Path deploy\app

        # Copy JAR to app directory
        Copy-Item $jarFile.FullName -Destination deploy\app\m-inbody.jar
        Write-Host "Copied JAR to app directory"
      shell: pwsh

    - name: Create launcher script
      run: |
        Write-Host "Creating launcher batch script..."

        $launcherScript = @"
        @echo off
        setlocal enabledelayedexpansion

        cd /d "%~dp0"

        echo Starting M-INBODY...
        "%~dp0runtime\bin\java.exe" -Dfile.encoding=UTF-8 -Dconsole.encoding=UTF-8 -Dsun.stdout.encoding=UTF-8 -Dsun.stderr.encoding=UTF-8 -jar "%~dp0app\m-inbody.jar" %*
        "@

        Set-Content -Path deploy\app\M-INBODY.bat -Value $launcherScript
        Write-Host "Launcher script created"
      shell: pwsh

    - name: Build MSI installer with jpackage
      run: |
        Write-Host "Building Windows MSI installer with jpackage..."
        $javaHome = $env:JAVA_HOME
        Write-Host "JAVA_HOME: $javaHome"

        New-Item -ItemType Directory -Force -Path deploy\output

        # Create MSI installer with runtime
        & "$javaHome\bin\jpackage.exe" `
          --type msi `
          --name M-INBODY `
          --app-version 3.7.3 `
          --input deploy\app `
          --main-jar m-inbody.jar `
          --main-class org.springframework.boot.loader.launch.JarLauncher `
          --dest deploy\output `
          --java-options "-Dfile.encoding=UTF-8" `
          --java-options "-Dconsole.encoding=UTF-8" `
          --java-options "-Dsun.stdout.encoding=UTF-8" `
          --java-options "-Dsun.stderr.encoding=UTF-8" `
          --win-console `
          --win-dir-chooser `
          --win-menu `
          --win-shortcut

        Write-Host "MSI installer created successfully"
        Get-ChildItem -Path deploy\output -Recurse
      shell: pwsh

    - name: Upload MSI installer
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: deploy/output/*.msi

  create-release:
    name: Create Release
    needs: [build-jar, build-windows-exe]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - uses: actions/checkout@v3

    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: jar-file
        path: artifacts/

    - name: Download Windows installer
      uses: actions/download-artifact@v4
      with:
        name: windows-installer
        path: artifacts/

    - name: Get version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.version.outputs.VERSION }}
        body: |
          ## M-Inbody ${{ steps.version.outputs.VERSION }}

          ### ìƒˆë¡œìš´ ê¸°ëŠ¥
          - ğŸ“Š **íŒ¨í‚· í†µê³„ ìˆ˜ì§‘ ê¸°ëŠ¥ ì¶”ê°€**
            - ê²Œì„ìœ¼ë¡œë¶€í„° ìˆ˜ì‹ í•˜ëŠ” ëª¨ë“  íŒ¨í‚· íƒ€ì…ì„ ìë™ìœ¼ë¡œ ì¶”ì 
            - ìƒˆë¡œìš´ íŒ¨í‚· ë°œê²¬ ì‹œ ì½˜ì†”ì— ì‹¤ì‹œê°„ ì¶œë ¥
            - 30ì´ˆë§ˆë‹¤ ìë™ìœ¼ë¡œ JSON/CSV/Raw ë°ì´í„° íŒŒì¼ ì €ì¥

          - ğŸ” **ë¯¸ì§€ì˜ íŒ¨í‚· ë¶„ì„ ë„êµ¬**
            - íŒŒì‹±ë˜ì§€ ì•Šì€ íŒ¨í‚·ì˜ 16ì§„ìˆ˜ ë¤í”„
            - íŒ¨í‚· íƒ€ì…ë³„ ë¹ˆë„ í†µê³„
            - REST APIë¡œ ì‹¤ì‹œê°„ í†µê³„ ì¡°íšŒ ê°€ëŠ¥

          - ğŸ“ **ìë™ íŒŒì¼ ì €ì¥**
            - ì €ì¥ ìœ„ì¹˜: `~/m-inbody-packets/`
            - `packet-stats-latest.json` - ì „ì²´ í†µê³„
            - `packet-stats-latest.csv` - Excel í˜¸í™˜ CSV
            - `raw-dump-latest.txt` - Raw ë°ì´í„° ë¤í”„

          ### ì„¤ì¹˜ ë°©ë²•

          **Windows:**
          1. `M-INBODY-*.msi` ë‹¤ìš´ë¡œë“œ
          2. MSI íŒŒì¼ ì‹¤í–‰ (ìë™ìœ¼ë¡œ ê´€ë¦¬ì ê¶Œí•œ ìš”ì²­)
          3. ì„¤ì¹˜ ì™„ë£Œ í›„ ì‹œì‘ ë©”ë‰´ ë˜ëŠ” ë°”íƒ•í™”ë©´ ì•„ì´ì½˜ìœ¼ë¡œ ì‹¤í–‰
          4. Npcap ì„¤ì¹˜ í•„ìš” ì‹œ: https://npcap.com/dist/npcap-1.79.exe

          **ê¸°íƒ€ í”Œë«í¼ (Java í•„ìš”):**
          1. `m-inbody-*.jar` ë‹¤ìš´ë¡œë“œ
          2. `java -jar m-inbody-*.jar` ì‹¤í–‰

          ### ì‚¬ìš© ë°©ë²•

          ìì„¸í•œ ë‚´ìš©ì€ [PACKET_ANALYSIS.md](https://github.com/doorBW/m-inbody/blob/main/PACKET_ANALYSIS.md) ì°¸ê³ 

          ### REST API
          ```bash
          # í†µê³„ ì¡°íšŒ
          curl http://localhost:5000/api/v1/packet-stats/summary

          # ìˆ˜ë™ ì €ì¥
          curl -X POST http://localhost:5000/api/v1/packet-stats/save

          # í†µê³„ ì´ˆê¸°í™”
          curl -X DELETE http://localhost:5000/api/v1/packet-stats/clear
          ```
        files: |
          artifacts/*.jar
          artifacts/*.msi
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}